<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Miss Universe Hub</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

<style>
  /* --- Estilos Globales y Compartidos --- */
  :root{
    --bg:#050505; --panel:#0a0a0aef; --divider:#333; --text:#f0f0f0;
    --gold-1: #bf953f; --gold-2: #fcf6ba; --gold-3: #b38728; --gold-4: #fbf5b7; --gold-5: #aa771c;
    --silver-1: #bcc6cc; --silver-2: #eee; --silver-3: #999;
    --bronze-1: #cd7f32; --bronze-2: #eec7a3; --bronze-3: #8c5e2c;
    --card-bg-1: #fffce6; --card-bg-2: #f7e8a4; --card-text: #3d2b05;
    --accent: var(--gold-1);
    --font-display: 'Cinzel', serif;
    --font-body: 'Playfair Display', serif;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:var(--font-body); overflow-x:hidden;}
  #p5-background { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.6; }

  /* --- Mobile Warning Overlay --- */
  .mobile-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    padding: 20px; text-align: center;
  }
  .mobile-msg {
    background: var(--panel); border: 2px solid var(--gold-5);
    padding: 30px; border-radius: 8px; max-width: 400px;
    box-shadow: 0 0 50px var(--gold-5);
  }
  .mobile-msg h2 { font-family: var(--font-display); color: var(--gold-2); font-size: 24px; margin-top: 0; text-transform: uppercase; }
  .mobile-msg p { font-family: var(--font-body); font-size: 18px; line-height: 1.5; color: #ddd; }
  .mobile-msg button { margin-top: 20px; padding: 10px 20px; background: transparent; border: 1px solid var(--gold-2); color: var(--gold-2); font-family: var(--font-display); text-transform: uppercase; cursor: pointer; }

  /* --- Modal de B√∫squeda por Slot --- */
  #slot-search-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 5000;
    display: none; justify-content: center; align-items: flex-start;
    padding-top: 100px;
  }
  .search-modal-content {
    background: var(--panel); border: 1px solid var(--gold-5);
    width: 90%; max-width: 500px; border-radius: 8px; padding: 20px;
    box-shadow: 0 0 30px #000;
  }
  .search-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .search-modal-header h3 { margin: 0; font-family: var(--font-display); color: var(--gold-2); }
  .close-modal { cursor: pointer; font-size: 24px; color: #999; }
  .close-modal:hover { color: #fff; }
  #slot-search-input {
    width: 100%; padding: 12px; background: #000; border: 1px solid var(--gold-5);
    color: #fff; font-family: var(--font-body); font-size: 16px; margin-bottom: 15px;
  }
  #slot-search-results { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
  .search-result-item {
    padding: 10px; background: #ffffff10; cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: background 0.2s;
  }
  .search-result-item:hover { background: var(--gold-5); color: #000; }
  .search-result-item img { width: 24px; border-radius: 2px; }

  /* --- Navegaci√≥n --- */
  .hub-nav {
    display: flex; justify-content: center; gap: 5px;
    padding: 10px; background: #0c0c0c; border-bottom: 2px solid var(--gold-5);
    position: sticky; top: 0; z-index: 100;
  }
  .tab-btn {
    font-family: var(--font-display); font-weight: 700; font-size: 16px;
    letter-spacing: 1px; text-transform: uppercase;
    padding: 12px 24px; border: none; background: transparent; color: var(--gold-4);
    cursor: pointer; transition: all .2s; border-bottom: 3px solid transparent;
  }
  .tab-btn:hover { color: #fff; background: #ffffff10; }
  .tab-btn.active { color: var(--gold-2); border-bottom-color: var(--gold-2); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* --- Estilos App 1: Top Builder --- */
  #app-top-builder .app{max-width:1400px; margin:20px auto 0; padding:0 20px 180px;}
  #app-top-builder .topbar{text-align:center; margin-bottom:30px; padding: 20px; background: linear-gradient(to bottom, #0000, #000a); border-bottom: 1px solid #ffffff20;}
  #app-top-builder .title{
    font-family: var(--font-display); font-weight:900; font-size:42px; letter-spacing:2px;
    background: linear-gradient(to right, var(--gold-1), var(--gold-2), var(--gold-3), var(--gold-4), var(--gold-5));
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0px 2px 10px #00000080;
    text-transform: uppercase; margin: 0;
  }
  #app-top-builder .hint{color:#bbb; font-size:16px; font-family:var(--font-display); letter-spacing:1px; margin-top: 8px;}
/* Busca esto en el <style> y actual√≠zalo: */
#app-top-builder .grid {
  display: grid; 
  gap: 20px; 
  /* Cambio: 3 columnas iguales y una un poco m√°s peque√±a para el Top 3 */
  grid-template-columns: 1fr 1fr 1fr 0.8fr; 
}
  #app-top-builder .col{background:var(--panel); border:1px solid #ffffff15; border-radius:4px; padding:15px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px #00000050;}
  #app-top-builder .col h2{margin:0 0 15px 0; font-size:24px; color:var(--gold-2); text-align:center; font-family: var(--font-display); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--gold-5); padding-bottom: 10px;}
  #app-top-builder .slots{min-height: 600px; display:grid; grid-template-rows: repeat(var(--rows), 1fr); gap:10px;}
  @media (max-width: 1100px){ #app-top-builder .grid{grid-template-columns:1fr 1fr; gap:15px} #app-top-builder .col:nth-child(3), #app-top-builder .col:nth-child(4) { grid-column: span 1; } }
  @media (max-width: 768px){ #app-top-builder .grid{grid-template-columns:1fr} }
  
  #app-top-builder .slot{
    position:relative; display:flex; align-items:center; gap:15px;
    border:1px solid #ffffff10; background: #00000060;
    padding:4px 12px 4px 60px; min-height: 55px;
    transition: all .3s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer; /* Indicar que es clicable */
  }
  #app-top-builder .slot:hover { background: #ffffff08; border-color: var(--gold-5); }
  
  #app-top-builder .slot > * { pointer-events: none; }
  #app-top-builder .slot .num{
    position:absolute; left:10px; font-family: var(--font-display);
    width:40px; height:100%; display:flex; align-items:center; justify-content:center;
    font-size:20px; font-weight:900; color:#ffffff40; border-right: 1px solid #ffffff10;
  }
  #app-top-builder .slot .photo{ width:44px; height:44px; border-radius:50%; border:2px solid var(--gold-1); overflow:hidden; display:none; background:#111; flex-shrink:0; box-shadow: 0 0 15px #000; }
  #app-top-builder .slot .photo img{width:100%; height:100%; object-fit:cover}
  #app-top-builder .slot .name {
    font-family: var(--font-display); font-size: 15px; letter-spacing: 1px;
    text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;
    color: #999; display: flex; align-items: center; gap: 10px;
  }
  #app-top-builder .slot-flag { width: 24px; height: auto; border-radius: 2px; box-shadow: 0 2px 5px #000; }
  #app-top-builder .slot.drag-hover { background: #ffffff10 !important; border-color: var(--gold-2) !important; transform: scale(1.03); z-index:10; }
  #app-top-builder .slot.occupied { background: linear-gradient(to right, #111, #222); border-color: var(--gold-5); }
  #app-top-builder .slot.occupied .name { color: #fff; font-weight: 700; }
  #app-top-builder .slot.occupied .num { color: var(--gold-2); text-shadow: 0 0 10px var(--gold-5); }
  #app-top-builder .slot[data-band="E"].occupied { background: #1a1a1a; border-color: var(--divider); }
  #app-top-builder .slot[data-band="E"].occupied .num { color: var(--silver-3); }
  #app-top-builder .slot[data-band="E"] .num { font-size: 16px; }
  #app-top-builder .slot[data-rank="3"].occupied { background: linear-gradient(135deg, var(--bronze-3), var(--bronze-1)); border: 1px solid var(--bronze-2); }
  #app-top-builder .slot[data-rank="2"].occupied { background: linear-gradient(135deg, var(--silver-3), var(--silver-1)); border: 1px solid var(--silver-2); color: #000; }
  #app-top-builder .slot[data-rank="1"] { min-height: 75px; }
  #app-top-builder .slot[data-rank="1"].occupied {
    background: linear-gradient(135deg, var(--gold-5), var(--gold-1) 30%, var(--gold-2) 50%, var(--gold-1) 70%, var(--gold-3));
    border: 2px solid var(--gold-2); box-shadow: 0 0 30px var(--gold-5);
    animation: top-builder-winner-pulse 4s infinite alternate;
  }
  #app-top-builder .slot[data-rank="1"].occupied .name { color: #000; font-weight: 900; font-size: 22px; }
  #app-top-builder .slot[data-rank="1"].occupied .num { color: #000; border-right-color: #00000030; font-size: 28px; }
  @keyframes top-builder-winner-pulse { 0% { box-shadow: 0 0 20px var(--gold-5); } 100% { box-shadow: 0 0 50px var(--gold-2), inset 0 0 20px var(--gold-4); } }
  #app-top-builder .pool{margin-top:30px; background:var(--panel); border:1px solid var(--gold-5); backdrop-filter: blur(10px); padding:25px; border-radius: 4px;}
  #app-top-builder .pool h3{font-family: var(--font-display); color: var(--gold-2); font-size: 22px; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 2px;}
  #app-top-builder .pool.drag-hover { outline: 2px dashed var(--gold-2); background: #ffffff08; }
  #app-top-builder .pool-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
  #app-top-builder .pool-header h3 { margin: 0; }
  #app-top-builder #search-bar {
    background: #00000050; border: 1px solid var(--gold-5); border-radius: 3px;
    color: var(--text); padding: 10px 15px; font-family: var(--font-body);
    font-size: 16px; min-width: 300px;
  }
  #app-top-builder #search-bar::placeholder { color: #999; }
  #app-top-builder #search-bar:focus { background: #000; border-color: var(--gold-2); outline: none; }
  #app-top-builder .banca-container {
    padding: 15px; background: #00000030; border-radius: 4px;
    border: 1px solid #ffffff10; margin-bottom: 20px;
  }
  #app-top-builder .banca-container h4 {
    margin: 0 0 10px 0; font-family: var(--font-display);
    color: var(--silver-1); text-transform: uppercase;
    letter-spacing: 1px; font-weight: 700;
  }
  #app-top-builder #banca-slots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; min-height: auto; }
  @media (max-width: 768px) { #app-top-builder #banca-slots { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 480px) { #app-top-builder #banca-slots { grid-template-columns: repeat(2, 1fr); } }
  #app-top-builder .cards{display:flex; flex-wrap:wrap; gap:10px}
  #app-top-builder .card{
    background: linear-gradient(145deg, var(--card-bg-1) 10%, var(--card-bg-2) 90%);
    color: var(--card-text); font-family: var(--font-display); font-weight: 800;
    font-size: 13px; letter-spacing: 0.5px; padding: 8px 14px; cursor: grab; user-select: none;
    border: 1px solid var(--gold-1); border-radius: 3px;
    box-shadow: 0 4px 8px #00000060;
    display: flex; align-items: center; gap: 8px;
    transition: all .15s ease-out;
  }
  #app-top-builder .card:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 20px #00000080; background: var(--card-bg-1); }
  #app-top-builder .card:active{cursor:grabbing; transform:scale(0.98);}
  #app-top-builder .card.ghost { opacity: 0.4; filter: grayscale(1) brightness(0.7); }
  #app-top-builder .card-flag { width: 20px; height: 15px; object-fit: cover; border-radius: 2px; box-shadow: 0 1px 3px #00000040; }
  #app-top-builder .foot{margin-top: 50px; display:flex; justify-content:center; padding: 0 20px;}
  #app-top-builder .bar{background: #111; border:1px solid var(--gold-5); padding:15px 25px; display:flex; gap:15px; align-items:center; flex-wrap:wrap; box-shadow: 0 10px 40px #000; border-radius: 4px;}
  #app-top-builder .btn{border:0; padding:12px 24px; font-family: var(--font-display); font-weight:700; letter-spacing: 1px; text-transform: uppercase; cursor:pointer; transition: all .2s; background: transparent; color: var(--gold-2); border: 1px solid var(--gold-5);}
  #app-top-builder .btn:hover{ background: var(--gold-5); color: #000; box-shadow: 0 0 15px var(--gold-5); }
  #app-top-builder .btn.primary{ background: linear-gradient(135deg, var(--gold-1), var(--gold-5)); color:#000; border:none; }
  #app-top-builder .btn.primary:hover{ filter: brightness(1.2); }
  #app-top-builder .sep{width:1px; height:30px; background:var(--divider); margin:0 10px}
  #app-top-builder .status{font-family: var(--font-display); color:var(--gold-4); margin-left:15px}


  /* --- Estilos App 2: Votaciones --- */
  #app-scoring .app{max-width:700px; margin:20px auto; padding:0 20px 100px;}
  #app-scoring .topbar{text-align:center; margin-bottom:30px; padding: 20px 0; border-bottom: 1px solid #ffffff20;}
  #app-scoring .title{
    font-family: var(--font-display); font-weight:900; font-size:42px; letter-spacing:2px;
    background: linear-gradient(to right, var(--gold-1), var(--gold-2), var(--gold-3), var(--gold-4), var(--gold-5));
    -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    text-transform: uppercase; margin: 0;
  }
  #app-scoring .hint{color:#bbb; font-size:16px; font-family:var(--font-display); letter-spacing:1px; margin-top: 8px;}
  #app-scoring .carousel-nav{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding: 10px; background: #0a0a0a; border-radius: 4px; }
  #app-scoring .nav-btn{ background: var(--gold-5); color: #000; border:none; padding: 12px 20px; font-family: var(--font-display); font-weight: 700; font-size: 16px; cursor:pointer; transition: all .2s; border-radius: 3px; }
  #app-scoring .nav-btn:hover{ background: var(--gold-2); }
  #app-scoring .nav-btn:disabled{ background: var(--divider); color: #777; cursor:not-allowed; }
  #app-scoring #counter{ font-size: 18px; font-family: var(--font-display); color: var(--gold-2); }
  #app-scoring .carousel-wrapper{ perspective: 1000px; }
  #app-scoring #card-container{ position:relative; min-height: 550px; }
  #app-scoring .score-card{ position:absolute; width:100%; top:0; left:0; background: #111; border:1px solid var(--gold-5); border-radius:8px; padding:25px; box-shadow: 0 10px 40px #000; transition: transform .5s ease-out, opacity .5s ease-out; opacity: 0; transform: translateX(100%) rotateY(-20deg); }
  #app-scoring .score-card.active{ opacity: 1; transform: translateX(0) rotateY(0); z-index: 10; }
  #app-scoring .score-card.exiting{ opacity: 0; transform: translateX(-100%) rotateY(20deg); z-index: 5; }
  #app-scoring .card-header{ display:flex; align-items:center; gap:20px; border-bottom: 1px solid var(--divider); padding-bottom: 20px; margin-bottom: 20px; }
  #app-scoring .card-flag{ width: 100px; border-radius: 4px; box-shadow: 0 4px 15px #000; }
  #app-scoring .card-names{flex:1;}
  #app-scoring .card-country{ font-family: var(--font-display); font-size: 32px; font-weight: 900; color: var(--gold-2); margin: 0; text-transform: uppercase; }
  #app-scoring .card-delegate{ font-family: var(--font-body); font-size: 20px; color: var(--text); margin: 5px 0 0 0; font-style: italic; }
  #app-scoring .card-scores{ display:grid; grid-template-columns: 1fr 1fr; gap: 25px; }
  #app-scoring .score-col h3{ font-family: var(--font-display); color: var(--gold-4); font-size: 24px; margin: 0 0 15px 0; letter-spacing: 1px; border-bottom: 1px solid var(--gold-5); padding-bottom: 10px; }
  #app-scoring .score-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; }
  #app-scoring .score-row label{ font-family: var(--font-body); font-size: 18px; font-weight: 700; }
  #app-scoring .score-row input{ width: 80px; height: 50px; background: #000; border: 1px solid var(--divider); color: var(--gold-2); font-family: var(--font-display); font-size: 24px; font-weight: 700; text-align: center; border-radius: 4px; }
  #app-scoring .score-row input:focus{ outline: none; border-color: var(--gold-2); background: #111; }
  #app-scoring .ranking-container { margin-top: 40px; background: var(--panel); border: 1px solid var(--gold-5); border-radius: 4px; padding: 20px; }
  #app-scoring .ranking-container h2 { font-family: var(--font-display); color: var(--gold-2); text-align: center; text-transform: uppercase; font-size: 24px; margin: 0 0 20px 0; letter-spacing: 1px; border-bottom: 1px solid var(--gold-5); padding-bottom: 10px; }
  #app-scoring .rank-row { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 4px; border: 1px solid #ffffff10; margin-bottom: 8px; transition: all .2s; }
  #app-scoring .rank-row .rank-pos { font-family: var(--font-display); font-weight: 900; font-size: 20px; color: #ffffff40; width: 35px; text-align: center; flex-shrink: 0; border-right: 1px solid #ffffff10; }
  #app-scoring .rank-row .rank-name { font-family: var(--font-display); font-size: 16px; text-transform: uppercase; letter-spacing: 1px; color: #fff; font-weight: 700; display: flex; align-items: center; gap: 10px; flex-grow: 1; }
  #app-scoring .rank-row .rank-flag { width: 24px; height: auto; border-radius: 2px; }
  #app-scoring .rank-row .rank-score { font-family: var(--font-display); font-size: 20px; font-weight: 900; color: var(--gold-2); }
  #app-scoring .rank-row[data-rank="1"] { background: linear-gradient(135deg, var(--gold-5), var(--gold-1) 30%, var(--gold-2) 50%, var(--gold-1) 70%, var(--gold-3)); border: 1px solid var(--gold-2); }
  #app-scoring .rank-row[data-rank="1"] .rank-name, #app-scoring .rank-row[data-rank="1"] .rank-pos, #app-scoring .rank-row[data-rank="1"] .rank-score { color: #000; }
  #app-scoring .rank-row[data-rank="1"] .rank-pos { border-right-color: #00000030; }
  #app-scoring .rank-row[data-rank="2"] { background: linear-gradient(135deg, var(--silver-3), var(--silver-1)); border: 1px solid var(--silver-2); }
  #app-scoring .rank-row[data-rank="2"] .rank-name, #app-scoring .rank-row[data-rank="2"] .rank-pos, #app-scoring .rank-row[data-rank="2"] .rank-score { color: #000; }
  #app-scoring .rank-row[data-rank="2"] .rank-pos { border-right-color: #00000030; }
  #app-scoring .rank-row[data-rank="3"] { background: linear-gradient(135deg, var(--bronze-3), var(--bronze-1)); border: 1px solid var(--bronze-2); }
  #app-scoring .rank-row[data-rank="3"] .rank-name, #app-scoring .rank-row[data-rank="3"] .rank-pos { color: #fff; text-shadow: 0 1px 1px #000; }
  #app-scoring .rank-row[data-rank="3"] .rank-score { color: var(--gold-4); }

</style>
</head>
<body>

<div id="p5-background"></div>

<div id="mobile-warning" class="mobile-overlay" style="display:none">
  <div class="mobile-msg">
    <h2>‚ö†Ô∏è Atenci√≥n</h2>
    <p>Esta aplicaci√≥n est√° dise√±ada y optimizada para escritorio.</p>
    <p>Para la mejor experiencia, por favor √°brela en una computadora o tablet grande.</p>
    <button id="btn-close-mobile">Entendido</button>
  </div>
</div>

<div id="slot-search-modal">
  <div class="search-modal-content">
    <div class="search-modal-header">
      <h3>Asignar Delegada</h3>
      <span class="close-modal" id="close-slot-search">&times;</span>
    </div>
    <input type="text" id="slot-search-input" placeholder="Escribe el nombre del pa√≠s...">
    <div id="slot-search-results"></div>
  </div>
</div>

<nav class="hub-nav">
  <button class="tab-btn active" data-tab="app-top-builder">MU25 TOP</button>
  <button class="tab-btn" data-tab="app-scoring">Votaciones en vivo</button>
</nav>

<div id="app-top-builder" class="tab-content active">
  <div class="app">
    <div class="topbar">
      <h1 class="title">Miss Universe Official Top</h1>
      <div class="hint">Arrastra a tus favoritas hacia la corona o haz clic en una casilla vac√≠a para buscar.</div>
    </div>
    <div class="grid">
        <section class="col"><h2>Ronda 1 (30-22)</h2><div id="col-A"></div></section>
        <section class="col"><h2>Ronda 2 (21-13)</h2><div id="col-B"></div></section>
        <section class="col"><h2>Top 12 (12-4)</h2> <div id="col-C"></div></section>
         <section class="col"><h2>Top 3 Final</h2>  <div id="col-D"></div></section>
    </div>
    <section class="pool" id="pool">
      <div class="pool-header">
        <h3>Delegadas Disponibles (<span id="pool-count">0</span>)</h3>
        <input type="search" id="search-bar" placeholder="Buscar delegada...">
      </div>
      <div class="banca-container">
        <h4>Banca</h4>
        <div id="banca-slots"></div>
      </div>
      <div id="cards" class="cards"></div>
    </section>
    <div class="foot">
      <div class="bar">
        <button id="btn-clear" class="btn">Limpiar Todo</button>
        <span class="sep"></span>
        <button id="btn-shuffle" class="btn">Mezclar</button>
        <button id="btn-sort" class="btn">A-Z</button>
        <span class="sep"></span>
        <button id="btn-import" class="btn">Importar Top</button>
        <button id="btn-export" class="btn primary">Exportar Top Final</button>
        <span class="status" id="status-text">Preparado</span>
      </div>
    </div>
  </div>
  <input type="file" id="file-import-top" accept=".json" style="display: none;">
</div>

<div id="app-scoring" class="tab-content">
  <div class="app">
    <div class="topbar">
      <h1 class="title">Votaciones en Vivo</h1>
      <div class="hint">Puntuaciones de 0 a 10</div>
    </div>
    <div class="carousel-nav">
      <button id="btn-prev" class="nav-btn">Anterior</button>
      <div id="counter">0 / 0</div>
      <button id="btn-next" class="nav-btn">Siguiente</button>
    </div>
    <div class="carousel-wrapper">
      <div id="card-container" class="card-container"></div>
    </div>
    <div class="ranking-container">
      <h2>Ranking en Vivo (Top 30)</h2>
      <div id="ranking-list"></div>
    </div>
  </div>
</div>

<script>
// --- Detecci√≥n M√≥vil ---
(function() {
  if (window.innerWidth < 768) {
    const modal = document.getElementById('mobile-warning');
    if (modal) {
      modal.style.display = 'flex';
      document.getElementById('btn-close-mobile').onclick = () => { modal.style.display = 'none'; };
    }
  }
})();

// --- p5.js Fondo ---
function setup() { let cnv = createCanvas(windowWidth, windowHeight); cnv.parent('p5-background'); noStroke(); }
function windowResized() { resizeCanvas(windowWidth, windowHeight); }
let particles = [];
function draw() {
  clear(); if (frameCount % 5 === 0) particles.push(new Particle());
  for (let i = particles.length - 1; i >= 0; i--) { particles[i].update(); particles[i].show(); if (particles[i].finished()) particles.splice(i, 1); }
}
class Particle {
  constructor() { this.x = random(width); this.y = height + 50; this.vx = random(-0.5, 0.5); this.vy = random(-0.5, -2); this.alpha = 0; this.d = random(10, 100); }
  finished() { return this.y < -50; }
  update() { this.x += this.vx; this.y += this.vy; if (this.y > height - 100) this.alpha = min(this.alpha + 2, 50); else this.alpha = max(this.alpha - 0.5, 0); }
  show() { fill(255, 215, 0, this.alpha); circle(this.x, this.y, this.d); }
}

// --- Auto Scroll Logic ---
let autoScrollSpeed = 0;
document.addEventListener('dragover', (e) => {
  const threshold = 100; 
  if (e.clientY < threshold) {
    autoScrollSpeed = -15; 
  } else if (e.clientY > window.innerHeight - threshold) {
    autoScrollSpeed = 15;
  } else {
    autoScrollSpeed = 0;
  }
});
document.addEventListener('dragend', () => { autoScrollSpeed = 0; });

function scrollLoop() {
  if (autoScrollSpeed !== 0) {
    window.scrollBy(0, autoScrollSpeed);
  }
  requestAnimationFrame(scrollLoop);
}
scrollLoop();


// --- App 1: Creador de Top ---
function initTopBuilder() {
  (function(){
    let CONTESTANTS = [];
    const RANK_MAP = new Map();
    let CURRENT_DRAG = null;
    const RANGES = { 
        A: [30,29,28,27,26,25,24,23,22], // 9 espacios
        B: [21,20,19,18,17,16,15,14,13], // 9 espacios
        C: [12,11,10,9,8,7,6,5,4],       // 9 espacios (Top 12 starts)
        D: [3,2,1],                      // 3 espacios
        E: [-1,-2,-3,-4,-5]              // Banca
    };
    const STORAGE_KEY = 'mu_top_builder_v4'; 

    // Modal Elements
    const searchModal = document.getElementById('slot-search-modal');
    const searchInput = document.getElementById('slot-search-input');
    const searchResults = document.getElementById('slot-search-results');
    const closeSearch = document.getElementById('close-slot-search');
    let activeSearchRank = null;

    function init() {
      for (const band in RANGES) {
        const col = (band === 'E') ? document.getElementById('banca-slots') : document.getElementById(`col-${band}`);   
        col.innerHTML = '';
        if (band !== 'E') { col.classList.add('slots'); col.style.setProperty('--rows', RANGES[band].length); }
        RANGES[band].forEach(rank => col.appendChild(createSlotEl(band, rank)));
      }
      
      fetch('delegates.json').then(r=>r.json()).then(data => {
          CONTESTANTS = data.map(d => typeof d === 'string' ? {name:d, code:''} : d).sort((a,b) => a.name.localeCompare(b.name));
          const rawData = localStorage.getItem(STORAGE_KEY);
          if (rawData !== null) {
            console.log("TOP BUILDER: Sesi√≥n cargada.");
            loadFromStorage(rawData); 
            updateUI();
          } else {
            console.log("TOP BUILDER: Inicio vac√≠o (v4).");
            updateUI();
          }
      }).catch(e => { console.error(e); document.getElementById('status-text').textContent = 'Error cargando delegates.json'; updateUI(); });
      
      setupGlobalListeners(); 
      setupButtons();
      setupSearchModal();
    }

    function flagURL(code) { return code ? `https://flagcdn.com/w40/${code.toLowerCase()}.png` : ''; }

    function createSlotEl(band, rank) {
      const el = document.createElement('div');
      el.className = 'slot'; el.dataset.rank = rank; el.dataset.band = band; el.draggable = true;
      let rankDisplay = rank;
      if (band === 'E') rankDisplay = `B${Math.abs(rank)}`;
      else if(rank===1) rankDisplay="üëë"; else if(rank===2) rankDisplay="2¬∫"; else if(rank===3) rankDisplay="3¬∫";
      el.innerHTML = `<div class="num">${rankDisplay}</div><div class="photo"><img alt=""></div><div class="name">‚Äî</div>`;
      
      el.addEventListener('click', (e) => {
        if (!RANK_MAP.has(rank)) { 
          openSearchModal(rank);
        }
      });

      el.addEventListener('dragstart', e => {
        const r = Number(el.dataset.rank); const cData = RANK_MAP.get(r);
        if (!cData) { e.preventDefault(); return; }
        CURRENT_DRAG = { type: 'slot', rank: r, data: cData };
        el.classList.add('ghost'); e.dataTransfer.effectAllowed = 'move';
      });
      el.addEventListener('dragend', () => { el.classList.remove('ghost'); CURRENT_DRAG = null; document.querySelectorAll('.drag-hover').forEach(x => x.classList.remove('drag-hover')); });
      el.addEventListener('dragover', e => { if (!CURRENT_DRAG) return; e.preventDefault(); e.dataTransfer.dropEffect = 'move'; el.classList.add('drag-hover'); });
      el.addEventListener('dragleave', () => el.classList.remove('drag-hover'));
      el.addEventListener('drop', e => {
        e.preventDefault(); el.classList.remove('drag-hover');
        if (!CURRENT_DRAG) return;
        const targetRank = Number(el.dataset.rank);
        if (CURRENT_DRAG.type === 'card') assignRank(CURRENT_DRAG.data, targetRank);
        else if (CURRENT_DRAG.type === 'slot') swapRanks(CURRENT_DRAG.rank, targetRank);
      });
      return el;
    }

    function setupSearchModal() {
      closeSearch.onclick = () => { searchModal.style.display = 'none'; };
      window.onclick = (e) => { if (e.target == searchModal) searchModal.style.display = 'none'; };
      
      searchInput.addEventListener('input', () => {
        renderSearchResults(searchInput.value);
      });
    }

    function openSearchModal(rank) {
      activeSearchRank = rank;
      searchInput.value = '';
      renderSearchResults('');
      searchModal.style.display = 'flex';
      searchInput.focus();
    }

    function renderSearchResults(query) {
      searchResults.innerHTML = '';
      const assignedNames = new Set([...RANK_MAP.values()].map(d => d.name));
      
      const filtered = CONTESTANTS.filter(c => {
        const nameMatch = c.name.toLowerCase().includes(query.toLowerCase());
        const notAssigned = !assignedNames.has(c.name);
        return nameMatch && notAssigned;
      });

      filtered.forEach(c => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.innerHTML = `<img src="${flagURL(c.code)}"> ${c.name}`;
        item.onclick = () => {
          assignRank(c, activeSearchRank);
          searchModal.style.display = 'none';
        };
        searchResults.appendChild(item);
      });
    }

    function setupGlobalListeners() {
      const pool = document.getElementById('pool');
      pool.addEventListener('dragover', e => { if (CURRENT_DRAG?.type === 'slot') { e.preventDefault(); pool.classList.add('drag-hover'); } });
      pool.addEventListener('dragleave', () => pool.classList.remove('drag-hover'));
      pool.addEventListener('drop', e => { e.preventDefault(); pool.classList.remove('drag-hover'); if (CURRENT_DRAG?.type === 'slot') unassignRank(CURRENT_DRAG.rank); });
    }

    function assignRank(cData, rank) {
      for (const [r, d] of RANK_MAP.entries()) { if (d.name === cData.name) RANK_MAP.delete(r); }
      RANK_MAP.set(Number(rank), cData); updateUI(); save();
    }
    function swapRanks(r1, r2) {
      const d1 = RANK_MAP.get(r1), d2 = RANK_MAP.get(r2);
      if (d1) RANK_MAP.set(r2, d1); else RANK_MAP.delete(r2);
      if (d2) RANK_MAP.set(r1, d2); else RANK_MAP.delete(r1);
      updateUI(); save();
    }
    function unassignRank(r) { RANK_MAP.delete(Number(r)); updateUI(); save(); }

    function loadTopFromJSON(topData) {
      if (!topData) return;
      try {
        RANK_MAP.clear(); let loadedCount = 0;
        for (const rankStr in topData) {
          const rank = Number(rankStr);
          const countryName = topData[rankStr];
          if (countryName && rank >= 1 && rank <= 30) {
            const cData = CONTESTANTS.find(c => c.name === countryName);
            if (cData) { RANK_MAP.set(rank, cData); loadedCount++; }
          }
        }
        console.log(`(Importar) Se cargaron ${loadedCount} delegadas.`);
      } catch (e) { alert("Error: El archivo JSON no tiene el formato esperado."); }
      updateUI(); save();     
    }

    function updateUI() {
      document.querySelectorAll('#app-top-builder .slot').forEach(slot => {
        const rank = Number(slot.dataset.rank); const cData = RANK_MAP.get(rank);
        const nameEl = slot.querySelector('.name'); const imgEl = slot.querySelector('.photo img');
        if (cData) {
          slot.classList.add('occupied');
          nameEl.innerHTML = `<img class="slot-flag" src="${flagURL(cData.code)}" alt="${cData.code}"> ${cData.name}`;
          if (imgEl) imgEl.src = `photos/${cData.name}.png`;
        } else {
          slot.classList.remove('occupied'); nameEl.textContent = '‚Äî';
          if (imgEl) imgEl.removeAttribute('src');
        }
      });
      const cardsEl = document.getElementById('cards'); cardsEl.innerHTML = '';
      const assignedNames = new Set([...RANK_MAP.values()].map(d => d.name));
      CONTESTANTS.filter(c => !assignedNames.has(c.name)).forEach(c => {
        const card = document.createElement('div'); card.className = 'card'; card.draggable = true;
        card.innerHTML = `<img class="card-flag" src="${flagURL(c.code)}" alt="${c.code}"> ${c.name}`; 
        card.addEventListener('dragstart', () => { CURRENT_DRAG = { type: 'card', data: c }; card.classList.add('ghost'); });
        card.addEventListener('dragend', () => { card.classList.remove('ghost'); CURRENT_DRAG = null; });
        cardsEl.appendChild(card);
      });
      document.getElementById('pool-count').textContent = CONTESTANTS.length - RANK_MAP.size;
      document.getElementById('status-text').textContent = `${RANK_MAP.size} Top Confirmado`;
      filterPoolCards();
    }

    function filterPoolCards() {
      const searchTerm = document.getElementById('search-bar').value.toLowerCase();
      const cards = document.getElementById('cards').children;
      for (const card of cards) {
        const name = card.textContent.toLowerCase();
        card.style.display = name.includes(searchTerm) ? 'flex' : 'none';
      }
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify([...RANK_MAP])); }
    function loadFromStorage(rawData) {
      try {
        const raw = JSON.parse(rawData); 
        raw.forEach(([r, data]) => {
          const cData = typeof data === 'string' ? {name: data, code: ''} : data;
          RANK_MAP.set(Number(r), cData);
        });
      } catch(e){ console.error("Error al cargar desde localStorage:", e); }
    }
    
    function setupButtons() {
      document.getElementById('btn-clear').onclick = () => { RANK_MAP.clear(); updateUI(); save(); };
      document.getElementById('btn-shuffle').onclick = () => { CONTESTANTS.sort(()=>Math.random()-.5); updateUI(); };
      document.getElementById('btn-sort').onclick = () => { CONTESTANTS.sort((a,b)=>a.name.localeCompare(b.name)); updateUI(); };
      document.getElementById('btn-export').onclick = () => {
        const d={}; for(let i=1;i<=30;i++) { const data = RANK_MAP.get(i); d[i] = data ? data.name : null; }
        const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
        a.download='miss_universe_top.json'; a.click();
      };

      const importBtn = document.getElementById('btn-import');
      const fileInput = document.getElementById('file-import-top');
      importBtn.onclick = () => { fileInput.click(); };
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try { loadTopFromJSON(JSON.parse(event.target.result)); } catch (err) { alert("Error: El archivo no es un JSON v√°lido."); }
          e.target.value = null; 
        };
        reader.readAsText(file);
      };
      document.getElementById('search-bar').addEventListener('input', filterPoolCards);
    }
    init(); 
  })();
}


// --- App 2: Votaciones en Vivo ---
function initScoring() {
  (function() {
    let DELEGATES = [];
    let SCORES = {};
    let currentIndex = 0;
    const STORAGE_KEY = 'mu_scores_master_v3'; 
    const container = document.querySelector('#app-scoring #card-container');
    const btnPrev = document.querySelector('#app-scoring #btn-prev');
    const btnNext = document.querySelector('#app-scoring #btn-next');
    const counterEl = document.querySelector('#app-scoring #counter');
    const rankingListEl = document.querySelector('#app-scoring #ranking-list');

    function init() {
      if (!container) return;
      loadScores();
      fetch('delegates.json').then(r => r.json()).then(data => {
          DELEGATES = data.sort((a, b) => a.name.localeCompare(b.name));
          container.innerHTML = ''; 
          DELEGATES.forEach((delegate, index) => { container.appendChild(createCardEl(delegate, index)); });
          showCard(0); setupListeners(); updateRankingTable(); 
        });
    }
    
    function createCardEl(delegate, index) {
      const el = document.createElement('div');
      el.className = 'score-card'; el.dataset.index = index; el.dataset.name = delegate.name;
      const delegateScores = SCORES[delegate.name] || {};
      el.innerHTML = `
        <div class="card-header">
          <img class="card-flag" src="https://flagcdn.com/w160/${delegate.code.toLowerCase()}.png" alt="${delegate.name}">
          <div class="card-names"><h2 class="card-country">${delegate.name}</h2><p class="card-delegate">${delegate.delegate}</p></div>
        </div>
        <div class="card-scores">
          <div class="score-col"><h3>Preliminar</h3>
            <div class="score-row"><label for="pre-swim-${index}">Traje de Ba√±o</label><input type="number" id="pre-swim-${index}" class="score-input" data-category="pre_swim" min="0" max="10" step="0.1" value="${delegateScores.pre_swim || ''}"></div>
            <div class="score-row"><label for="pre-gown-${index}">Traje de Noche</label><input type="number" id="pre-gown-${index}" class="score-input" data-category="pre_gown" min="0" max="10" step="0.1" value="${delegateScores.pre_gown || ''}"></div>
          </div>
          <div class="score-col"><h3>Final</h3>
            <div class="score-row"><label for="fin-swim-${index}">Traje de Ba√±o</label><input type="number" id="fin-swim-${index}" class="score-input" data-category="fin_swim" min="0" max="10" step="0.1" value="${delegateScores.fin_swim || ''}"></div>
            <div class="score-row"><label for="fin-gown-${index}">Traje de Noche</label><input type="number" id="fin-gown-${index}" class="score-input" data-category="fin_gown" min="0" max="10" step="0.1" value="${delegateScores.fin_gown || ''}"></div>
            <div class="score-row"><label for="fin-q-${index}">Preguntas</label><input type="number" id="fin-q-${index}" class="score-input" data-category="fin_q" min="0" max="10" step="0.1" value="${delegateScores.fin_q || ''}"></div>
          </div>
        </div>`;
      return el;
    }
    
    function showCard(index) {
      const cards = container.children; if (!cards.length) return;
      const currentCard = cards[currentIndex]; const newCard = cards[index];
      if (index > currentIndex) { if (currentCard) currentCard.classList.add('exiting'); if (newCard) { newCard.classList.remove('exiting'); newCard.classList.add('active'); } } 
      else { if (currentCard) currentCard.classList.remove('active'); if (newCard) { newCard.classList.remove('exiting'); newCard.classList.add('active'); } }
      currentIndex = index; updateNav();
    }
    
    function updateNav() {
      if(counterEl) counterEl.textContent = `${currentIndex + 1} / ${DELEGATES.length}`;
      if(btnPrev) btnPrev.disabled = (currentIndex === 0);
      if(btnNext) btnNext.disabled = (currentIndex === DELEGATES.length - 1);
    }
    
    function setupListeners() {
      if(btnNext) btnNext.onclick = () => { if (currentIndex < DELEGATES.length - 1) showCard(currentIndex + 1); };
      if(btnPrev) btnPrev.onclick = () => { if (currentIndex > 0) showCard(currentIndex - 1); };
      container.addEventListener('input', e => {
        if (e.target.classList.contains('score-input')) {
          const card = e.target.closest('.score-card');
          let value = parseFloat(e.target.value);
          if (isNaN(value)) value = ''; else if (value > 10) { value = 10; e.target.value = 10; } else if (value < 0) { value = 0; e.target.value = 0; }
          saveScore(card.dataset.name, e.target.dataset.category, value);
        }
      });
    }
    
    function saveScore(delegateName, category, value) {
      if (!SCORES[delegateName]) SCORES[delegateName] = {};
      SCORES[delegateName][category] = value;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(SCORES));
      updateRankingTable(); 
    }
    
    function loadScores() { const raw = localStorage.getItem(STORAGE_KEY); if (raw) SCORES = JSON.parse(raw); }

    function updateRankingTable() {
      if (!rankingListEl) return;
      const rankedList = DELEGATES.map(delegate => {
        const scores = SCORES[delegate.name] || {};
        const total = (parseFloat(scores.pre_swim)||0) + (parseFloat(scores.pre_gown)||0) + (parseFloat(scores.fin_swim)||0) + (parseFloat(scores.fin_gown)||0) + (parseFloat(scores.fin_q)||0);
        return { ...delegate, totalScore: total };
      });
      const top30 = rankedList.sort((a, b) => b.totalScore - a.totalScore).slice(0, 30);
      rankingListEl.innerHTML = ''; 
      top30.forEach((delegate, index) => {
        const rank = index + 1;
        const row = document.createElement('div'); row.className = 'rank-row'; row.dataset.rank = rank;
        row.innerHTML = `<span class="rank-pos">${rank}</span><span class="rank-name"><img class="rank-flag" src="https://flagcdn.com/w40/${delegate.code.toLowerCase()}.png"> ${delegate.name}</span><span class="rank-score">${delegate.totalScore.toFixed(2)}</span>`;
        rankingListEl.appendChild(row);
      });
    }
    init(); 
  })();
}

// --- Hub ---
(function() {
  let isTopBuilderInitialized = false; let isScoringInitialized = false;
  const tabs = document.querySelectorAll('.tab-btn'); const contents = document.querySelectorAll('.tab-content');
  function switchTab(tabId) {
    contents.forEach(c => { c.classList.remove('active'); if (c.id === tabId) c.classList.add('active'); });
    tabs.forEach(t => { t.classList.remove('active'); if (t.dataset.tab === tabId) t.classList.add('active'); });
    if (tabId === 'app-top-builder' && !isTopBuilderInitialized) { initTopBuilder(); isTopBuilderInitialized = true; }
    if (tabId === 'app-scoring' && !isScoringInitialized) { initScoring(); isScoringInitialized = true; }
  }
  tabs.forEach(tab => { tab.addEventListener('click', () => { switchTab(tab.dataset.tab); }); });
  setTimeout(() => { switchTab('app-top-builder'); }, 100);
})();
</script>
</body>
</html>